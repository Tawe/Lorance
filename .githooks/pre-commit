#!/usr/bin/env bash
set -euo pipefail

# Block commits that include common secret patterns in tracked changes
PATTERNS=(
  "BEGIN PRIVATE KEY"
  "PRIVATE KEY-----"
  "ALGOLIA_ADMIN_KEY="
  "FIREBASE_PRIVATE_KEY="
  "GOOGLE_APPLICATION_CREDENTIALS="
  "AWS_SECRET_ACCESS_KEY"
  "GCP_SERVICE_ACCOUNT"
  "GITHUB_TOKEN"
  "SLACK_BOT_TOKEN"
  "SENTRY_AUTH_TOKEN"
  "STRIPE_SECRET_KEY"
  "TWILIO_AUTH_TOKEN"
)

DIFF=$(git diff --cached -U0)
FILES=$(git diff --cached --name-only)

# Allowlist files that may legitimately mention example keys
ALLOWLIST_FILES=(
  "README.md"
  ".env.example"
  "frontend/.env.local.example"
)

for f in "${ALLOWLIST_FILES[@]}"; do
  if echo "$FILES" | grep -x "$f" >/dev/null; then
    # Remove hunks for allowlisted files from the diff scan
    DIFF=$(printf "%s\n" "$DIFF" | awk -v file="a/$f" '
      BEGIN {skip=0}
      /^diff --git / {skip=($3==file); next}
      skip==0 {print}
    ')
  fi
done

for pat in "${PATTERNS[@]}"; do
  if echo "$DIFF" | grep -n "$pat" >/dev/null; then
    echo "pre-commit: blocked by secret pattern: $pat" >&2
    exit 1
  fi
 done

# Block committing known secret files if they ever get staged
BLOCKED_FILES=(
  "backend/.env"
  "frontend/.env.local"
  "lorance-1e920-firebase-adminsdk-fbsvc-7c64021090.json"
)

for f in "${BLOCKED_FILES[@]}"; do
  if git diff --cached --name-only | grep -x "$f" >/dev/null; then
    echo "pre-commit: blocked file staged: $f" >&2
    exit 1
  fi
 done

# Auto-sync AI instruction files if .ai/INSTRUCTIONS.md was staged
if git diff --cached --name-only | grep -q "^\.ai/INSTRUCTIONS\.md$"; then
  echo "pre-commit: syncing AI instruction files..."
  node scripts/ai-sync.mjs
  git add CLAUDE.md GEMINI.md AGENTS.md .github/copilot-instructions.md
fi

exit 0
